<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Trader Pro - Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f;
            color: #fff;
            min-height: 100vh;
            margin: 0;
            padding-bottom: 80px;
        }
        .glass {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            font-size: 15px;
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.8; }
        .btn-green { background: linear-gradient(135deg, #00c853 0%, #00e676 100%); color: #000; }
        .btn-red { background: linear-gradient(135deg, #ff1744 0%, #f50057 100%); }
        
        .signal-strong-buy { border-left: 4px solid #00ff88; background: rgba(0,255,136,0.15); }
        .signal-buy { border-left: 4px solid #00ff88; background: rgba(0,255,136,0.05); }
        .signal-hold { border-left: 4px solid #ffc107; background: rgba(255,193,7,0.1); }
        .signal-sell { border-left: 4px solid #ff3366; background: rgba(255,51,102,0.1); }
        
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(10,10,15,0.98);
            padding: 12px;
            display: flex;
            justify-content: space-around;
            border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .nav-btn { background: none; border: none; color: #666; font-size: 11px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-btn.active { color: #00ff88; }
        
        .hidden { display: none !important; }
        
        input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: white;
            margin-top: 8px;
            font-size: 16px;
        }
        
        .coin-card {
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 16px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .coin-card:active { transform: scale(0.98); }
        
        .position-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,255,136,0.9);
            color: #000;
            padding: 12px 24px;
            border-radius: 24px;
            opacity: 0;
            transition: 0.3s;
            pointer-events: none;
            z-index: 2000;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            overflow-y: auto;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div style="padding: 16px; max-width: 500px; margin: 0 auto;">
        
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h1 style="margin: 0; font-size: 24px; color: #00ff88; font-weight: 800;">AI Trader Pro</h1>
                <p id="lastUpdated" style="margin: 0; font-size: 10px; color: #555;">Updating...</p>
            </div>
            <button onclick="connectWallet()" class="btn" style="width: auto; padding: 8px 16px; font-size: 13px; background: rgba(255,255,255,0.1);">
                ðŸ¦Š <span id="walletText">Connect</span>
            </button>
        </div>

        <!-- Portfolio Card -->
        <div class="glass" style="background: linear-gradient(135deg, rgba(0,255,136,0.1) 0%, rgba(102,126,234,0.1) 100%); border: 1px solid rgba(0,255,136,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <p style="margin: 0; color: #00ff88; font-size: 12px; font-weight: 600; letter-spacing: 1px;">TOTAL BALANCE</p>
                    <h2 id="portValue" style="margin: 8px 0 0 0; font-size: 36px; color: white; font-weight: 800;">$0.00</h2>
                    <p id="portChange" style="margin: 4px 0 0 0; font-size: 14px; color: #888;">$0.00 (0.00%)</p>
                </div>
                <div style="text-align: right;">
                    <p style="margin: 0; font-size: 12px; color: #888;">Available Cash</p>
                    <p id="cashValue" style="margin: 4px 0 0 0; font-size: 18px; color: white; font-weight: 600;">$0.00</p>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="text-align: center;">
                    <p style="margin: 0; font-size: 11px; color: #888;">Positions</p>
                    <p id="posCount" style="margin: 4px 0 0 0; font-size: 20px; font-weight: 700; color: white;">0</p>
                </div>
                <div style="text-align: center;">
                    <p style="margin: 0; font-size: 11px; color: #888;">Win Rate</p>
                    <p id="winRateDisplay" style="margin: 4px 0 0 0; font-size: 20px; font-weight: 700; color: white;">--</p>
                </div>
                <div style="text-align: center;">
                    <p style="margin: 0; font-size: 11px; color: #888;">Market Value</p>
                    <p id="investedValue" style="margin: 4px 0 0 0; font-size: 20px; font-weight: 700; color: #00ff88;">$0.00</p>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div style="display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px;">
            <button onclick="showTab('signals')" id="tab-signals" class="btn" style="width: auto; background: rgba(0,255,136,0.2); color: #00ff88; flex-shrink: 0;">Signals</button>
            <button onclick="showTab('positions')" id="tab-positions" class="btn" style="width: auto; background: rgba(255,255,255,0.1); flex-shrink: 0;">Positions</button>
            <button onclick="showTab('history')" id="tab-history" class="btn" style="width: auto; background: rgba(255,255,255,0.1); flex-shrink: 0;">History</button>
            <button onclick="resetPortfolio()" class="btn" style="width: auto; background: rgba(255,51,102,0.1); color: #ff3366; flex-shrink: 0;">Reset</button>
        </div>

        <!-- Signals View -->
        <div id="view-signals">
            <div id="loading" style="text-align: center; padding: 40px;">
                <div class="animate-spin" style="width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #00ff88; border-radius: 50%; margin: 0 auto;"></div>
                <p style="color: #666; margin-top: 16px;">Analyzing markets...</p>
            </div>
            <div id="coinsList" class="hidden"></div>
        </div>

        <!-- Positions View -->
        <div id="view-positions" class="hidden">
            <div id="emptyPositions" class="glass" style="text-align: center; padding: 40px;">
                <p style="color: #666;">No open positions</p>
                <button onclick="showTab('signals')" class="btn btn-green" style="margin-top: 16px; width: auto;">Find Trades</button>
            </div>
            <div id="positionsList"></div>
        </div>

        <!-- History View -->
        <div id="view-history" class="hidden">
            <div id="historyList"></div>
        </div>
    </div>

    <!-- Trade Modal -->
    <div id="tradeModal" class="modal">
        <div style="max-width: 500px; margin: 0 auto; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin: 0; font-weight: 800;">Trade Details</h2>
                <button onclick="closeModal()" style="background: none; border: none; color: white; font-size: 32px; cursor: pointer; line-height: 1;">&times;</button>
            </div>

            <div class="glass">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <img id="modalImg" src="" style="width: 48px; height: 48px; border-radius: 50%; display: none;">
                    <div>
                        <h3 id="modalCoin" style="margin: 0; font-size: 24px; font-weight: 700;">--</h3>
                        <p id="modalPrice" style="margin: 4px 0 0 0; color: #00ff88; font-family: monospace; font-weight: 600;">--</p>
                    </div>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                    <p style="margin: 0 0 8px 0; color: #888; font-size: 12px; font-weight: 600;">RECOMMENDED POSITION (2% Risk)</p>
                    <p id="recAmount" style="margin: 0; font-size: 32px; font-weight: 800; color: #00ff88;">$0.00</p>
                    <p style="margin: 4px 0 0 0; color: #666; font-size: 12px;">Based on available cash</p>
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="color: #888; font-size: 14px; font-weight: 600;">Amount to Invest ($)</label>
                    <input type="number" id="tradeAmount" value="0" min="1" step="1">
                    <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">Available: $<span id="availableCash">0.00</span></p>
                </div>

                <button onclick="executeTrade()" class="btn btn-green" style="margin-bottom: 12px;">CONFIRM BUY</button>
                <button onclick="closeModal()" class="btn" style="background: rgba(255,255,255,0.1);">Cancel</button>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn active" onclick="showTab('signals')">ðŸ“Š<span>Signals</span></button>
        <button class="nav-btn" onclick="showTab('positions')">ðŸ’¼<span>Portfolio</span></button>
        <button class="nav-btn" onclick="refresh()">ðŸ”„<span>Refresh</span></button>
        <button class="nav-btn" onclick="showTab('history')">ðŸ“ˆ<span>History</span></button>
    </div>

    <div id="toast"></div>

    <script>
        // Constants
        const INITIAL_CASH = 1000; // Increased for better demo
        const COIN_IDS = 'pepe,shiba-inu,bonk,floki,wojak,dogecoin,solana,bitcoin,ethereum';
        
        // State
        let coins = [];
        let selected = null;
        let address = null;
        
        let state = {
            cash: INITIAL_CASH,
            startCash: INITIAL_CASH,
            positions: [],
            history: [],
            wins: 0,
            losses: 0
        };

        // Load from localStorage
        function load() {
            const saved = localStorage.getItem('ai_trader_portfolio_v2');
            if (saved) {
                state = JSON.parse(saved);
            }
            updateDisplay();
        }

        // Save to localStorage
        function save() {
            localStorage.setItem('ai_trader_portfolio_v2', JSON.stringify(state));
        }

        function resetPortfolio() {
            if (confirm('Are you sure you want to reset your portfolio? This will clear all positions and history.')) {
                state = {
                    cash: INITIAL_CASH,
                    startCash: INITIAL_CASH,
                    positions: [],
                    history: [],
                    wins: 0,
                    losses: 0
                };
                save();
                updateDisplay();
                showToast('Portfolio reset');
            }
        }

        // Update all displays
        function updateDisplay() {
            // Calculate current market value of all positions
            let currentMarketValue = 0;
            
            state.positions.forEach(pos => {
                const coin = coins.find(c => c.s === pos.coin);
                // Use current price if available, otherwise use entry price (fallback)
                const currentPrice = coin ? coin.p : pos.price;
                currentMarketValue += (pos.tokens * currentPrice);
            });
            
            const totalValue = state.cash + currentMarketValue;
            const totalPnl = totalValue - state.startCash;
            const totalPnlPct = (totalPnl / state.startCash) * 100;
            
            // Update UI elements
            document.getElementById('portValue').textContent = '$' + totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            const changeEl = document.getElementById('portChange');
            changeEl.textContent = (totalPnl >= 0 ? '+' : '-') + '$' + Math.abs(totalPnl).toFixed(2) + ' (' + (totalPnlPct >= 0 ? '+' : '') + totalPnlPct.toFixed(2) + '%)';
            changeEl.style.color = totalPnl >= 0 ? '#00ff88' : '#ff3366';
            
            document.getElementById('cashValue').textContent = '$' + state.cash.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('investedValue').textContent = '$' + currentMarketValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('posCount').textContent = state.positions.length;
            
            const totalTrades = state.wins + state.losses;
            document.getElementById('winRateDisplay').textContent = totalTrades > 0 ? Math.round((state.wins/totalTrades)*100) + '%' : '--';
            
            // Render Positions list
            renderPositions();
            
            // Render History
            renderHistory();
            
            save();
        }

        function renderPositions() {
            const list = document.getElementById('positionsList');
            const empty = document.getElementById('emptyPositions');
            
            if (state.positions.length === 0) {
                empty.style.display = 'block';
                list.innerHTML = '';
            } else {
                empty.style.display = 'none';
                list.innerHTML = state.positions.map(pos => {
                    const coin = coins.find(c => c.s === pos.coin);
                    const currentPrice = coin ? coin.p : pos.price;
                    const currentVal = pos.tokens * currentPrice;
                    const pnl = currentVal - pos.amount;
                    const pnlPct = (pnl / pos.amount) * 100;
                    
                    return `
                        <div class="position-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-size: 20px; font-weight: 800;">${pos.coin}</div>
                                <div style="color: ${pnl >= 0 ? '#00ff88' : '#ff3366'}; font-weight: 800; font-size: 18px;">
                                    ${pnl >= 0 ? '+' : '-'}$${Math.abs(pnl).toFixed(2)} (${pnlPct.toFixed(2)}%)
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px; color: #aaa; margin-bottom: 16px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                                <div><span style="color: #666">Invested:</span> $${pos.amount.toFixed(2)}</div>
                                <div><span style="color: #666">Value:</span> $${currentVal.toFixed(2)}</div>
                                <div><span style="color: #666">Entry:</span> $${formatPrice(pos.price)}</div>
                                <div><span style="color: #666">Current:</span> $${formatPrice(currentPrice)}</div>
                            </div>
                            <button onclick="sellPosition(${pos.id})" class="btn btn-red" style="padding: 10px; font-size: 14px; font-weight: 800;">CLOSE POSITION</button>
                        </div>
                    `;
                }).join('');
            }
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = state.history.slice().reverse().map(trade => `
                <div class="glass" style="border-left: 4px solid ${trade.pnl >= 0 ? '#00ff88' : '#ff3366'}; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 800; font-size: 16px;">${trade.coin} <span style="font-weight: 400; font-size: 12px; color: #666;">(Closed)</span></span>
                        <span style="color: ${trade.pnl >= 0 ? '#00ff88' : '#ff3366'}; font-weight: 800;">
                            ${trade.pnl >= 0 ? '+' : '-'}$${Math.abs(trade.pnl).toFixed(2)}
                        </span>
                    </div>
                    <div style="margin-top: 6px; font-size: 12px; color: #888; display: flex; justify-content: space-between;">
                        <span>${new Date(trade.closeTime).toLocaleString()}</span>
                        <span style="font-weight: 700; color: ${trade.pnl >= 0 ? '#00ff88' : '#ff3366'}">${trade.pnlPct.toFixed(2)}% ROI</span>
                    </div>
                </div>
            `).join('') || '<p style="color: #666; text-align: center; padding: 40px;">No trade history yet</p>';
        }

        function formatPrice(p) {
            if (p === 0) return '0.00';
            if (p < 0.000001) return p.toExponential(4);
            if (p < 0.01) return p.toFixed(8);
            if (p < 1) return p.toFixed(4);
            return p.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        // Fetch prices with improved signal logic
        async function fetchPrices() {
            try {
                const res = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${COIN_IDS}&order=market_cap_desc&sparkline=false&price_change_percentage=24h`);
                if (!res.ok) throw new Error('API limit');
                const data = await res.json();
                
                coins = data.map(c => {
                    const change = c.price_change_percentage_24h || 0;
                    
                    // DETERMINISTIC SIGNAL LOGIC (No more random signals)
                    // Logic: Strong Buy if dipping but high volume, or steady uptrend.
                    // For this demo, we'll use a mix of 24h change and market cap stability.
                    let score = 50 + (change * 2); // Base score on 24h change
                    if (c.total_volume > c.market_cap * 0.1) score += 10; // Bonus for high relative volume
                    
                    // Clamp score
                    score = Math.max(10, Math.min(99, Math.round(score)));
                    
                    return {
                        s: c.symbol.toUpperCase(),
                        n: c.name,
                        p: c.current_price,
                        c24: change,
                        mc: c.market_cap,
                        v: c.total_volume,
                        image: c.image,
                        score: score
                    };
                }).sort((a, b) => b.score - a.score);
                
                document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
                return true;
            } catch(e) {
                console.error('Fetch error:', e);
                // Fallback data if API fails
                if (coins.length === 0) {
                    coins = [
                        {s:'BTC', n:'Bitcoin', p:45000, c24:1.2, score:72, image:'https://assets.coingecko.com/coins/images/1/small/bitcoin.png'},
                        {s:'ETH', n:'Ethereum', p:2400, c24:-0.5, score:65, image:'https://assets.coingecko.com/coins/images/279/small/ethereum.png'},
                        {s:'SOL', n:'Solana', p:105, c24:5.4, score:88, image:'https://assets.coingecko.com/coins/images/4128/small/solana.png'},
                        {s:'PEPE', n:'Pepe', p:0.0000038, c24:12.2, score:92, image:'https://assets.coingecko.com/coins/images/29850/small/pepe-token.jpeg'},
                        {s:'SHIB', n:'Shiba Inu', p:0.000015, c24:2.1, score:68, image:'https://assets.coingecko.com/coins/images/11939/small/shiba.png'}
                    ];
                }
                document.getElementById('lastUpdated').textContent = 'Using cached data (API Limit)';
                return true;
            }
        }

        async function init() {
            await fetchPrices();
            renderCoins();
            updateDisplay();
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('coinsList').classList.remove('hidden');
        }

        function renderCoins() {
            const list = document.getElementById('coinsList');
            list.innerHTML = coins.map(c => {
                let sig = 'HOLD';
                let cls = 'signal-hold';
                
                if (c.score >= 85) { sig = 'STRONG BUY'; cls = 'signal-strong-buy'; }
                else if (c.score >= 70) { sig = 'BUY'; cls = 'signal-buy'; }
                else if (c.score <= 30) { sig = 'SELL'; cls = 'signal-sell'; }
                
                return `
                    <div class="coin-card ${cls}" onclick="openTrade('${c.s}')">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <img src="${c.image}" style="width: 40px; height: 40px; border-radius: 50%;">
                                <div>
                                    <div style="font-size: 18px; font-weight: 800;">${c.s}</div>
                                    <div style="font-size: 12px; color: #888;">${c.n}</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="background: rgba(255,255,255,0.1); color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 800; letter-spacing: 0.5px;">${sig}</div>
                                <div style="font-size: 11px; color: #666; margin-top: 4px; font-weight: 600;">AI Score: ${c.score}</div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 22px; font-family: monospace; font-weight: 700;">$${formatPrice(c.p)}</div>
                            <div style="color: ${c.c24 >= 0 ? '#00ff88' : '#ff3366'}; font-weight: 800; font-size: 16px;">
                                ${c.c24 >= 0 ? '+' : ''}${c.c24.toFixed(2)}%
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openTrade(sym) {
            selected = coins.find(c => c.s === sym);
            if (!selected) return;
            
            document.getElementById('modalCoin').textContent = selected.s;
            document.getElementById('modalImg').src = selected.image;
            document.getElementById('modalImg').style.display = 'block';
            document.getElementById('modalPrice').textContent = '$' + formatPrice(selected.p);
            
            // Recommended amount: 2% of current cash
            const recAmount = Math.max(10, state.cash * 0.02);
            document.getElementById('recAmount').textContent = '$' + recAmount.toFixed(2);
            document.getElementById('tradeAmount').value = Math.floor(recAmount);
            document.getElementById('availableCash').textContent = state.cash.toLocaleString(undefined, {minimumFractionDigits: 2});
            
            document.getElementById('tradeModal').style.display = 'block';
        }

        function executeTrade() {
            const amount = parseFloat(document.getElementById('tradeAmount').value);
            
            if (!amount || amount <= 0) {
                showToast('Enter valid amount', true);
                return;
            }
            if (amount > state.cash) {
                showToast('Insufficient cash', true);
                return;
            }
            
            // Deduct cash
            state.cash -= amount;
            
            const position = {
                id: Date.now(),
                coin: selected.s,
                amount: amount,
                tokens: amount / selected.p,
                price: selected.p,
                time: new Date().toISOString()
            };
            
            state.positions.push(position);
            updateDisplay();
            closeModal();
            showToast(`Bought ${selected.s} for $${amount.toFixed(2)}`);
        }

        function sellPosition(id) {
            const idx = state.positions.findIndex(p => p.id === id);
            if (idx === -1) return;
            
            const pos = state.positions[idx];
            const coin = coins.find(c => c.s === pos.coin);
            const sellPrice = coin ? coin.p : pos.price;
            const sellValue = pos.tokens * sellPrice;
            const pnl = sellValue - pos.amount;
            const pnlPct = (pnl / pos.amount) * 100;
            
            // Return cash + profit/loss
            state.cash += sellValue;
            
            state.history.push({
                ...pos,
                sellPrice: sellPrice,
                sellValue: sellValue,
                pnl: pnl,
                pnlPct: pnlPct,
                closeTime: new Date().toISOString()
            });
            
            if (pnl >= 0) state.wins++;
            else state.losses++;
            
            state.positions.splice(idx, 1);
            updateDisplay();
            showToast(`Sold ${pos.coin} for $${sellValue.toFixed(2)} (${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)})`);
        }

        function closeModal() {
            document.getElementById('tradeModal').style.display = 'none';
            selected = null;
        }

        function showTab(tab) {
            const views = ['signals', 'positions', 'history'];
            views.forEach(v => {
                document.getElementById('view-' + v).classList.toggle('hidden', v !== tab);
                const btn = document.getElementById('tab-' + v);
                if (btn) {
                    if (v === tab) {
                        btn.style.background = 'rgba(0,255,136,0.2)';
                        btn.style.color = '#00ff88';
                    } else {
                        btn.style.background = 'rgba(255,255,255,0.1)';
                        btn.style.color = 'white';
                    }
                }
            });
            
            // Update bottom nav
            document.querySelectorAll('.nav-btn').forEach((btn, i) => {
                const navTabs = ['signals', 'positions', null, 'history'];
                btn.classList.toggle('active', navTabs[i] === tab);
            });
        }

        async function refresh() {
            const refreshBtn = event.currentTarget;
            refreshBtn.classList.add('animate-spin');
            await fetchPrices();
            updateDisplay();
            setTimeout(() => {
                refreshBtn.classList.remove('animate-spin');
                showToast('Market data updated');
            }, 500);
        }

        function connectWallet() {
            if (!window.ethereum) {
                showToast('MetaMask not found', true);
                return;
            }
            window.ethereum.request({ method: 'eth_requestAccounts' }).then(accounts => {
                address = accounts[0];
                document.getElementById('walletText').textContent = address.slice(0,6) + '...';
                showToast('Wallet connected');
            }).catch(() => showToast('Connection failed', true));
        }

        function showToast(msg, isError) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.opacity = '1';
            t.style.background = isError ? 'rgba(255,51,102,0.9)' : 'rgba(0,255,136,0.9)';
            t.style.color = isError ? '#fff' : '#000';
            setTimeout(() => t.style.opacity = '0', 3000);
        }

        // Init
        load();
        init();
        
        // Auto-refresh prices every 60s (less aggressive than 30s)
        setInterval(() => {
            fetchPrices().then(() => {
                updateDisplay();
            });
        }, 60000);
    </script>
</body>
</html>
